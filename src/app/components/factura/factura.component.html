<app-sidebar></app-sidebar>

<div class="content">
  <div class="container mt-5">
    <h2 class="text-center mb-4">Gestión de Facturas</h2>

    <div class="d-flex mb-3 justify-content-between align-items-center">
      <button class="btn btn-primary" (click)="abrirModalNuevo()">+ Nueva Factura</button>
      <button class="btn btn-success" (click)="exportarAExcel()">XLS</button>
      <input 
        class="form-control w-25" 
        type="text" 
        placeholder="Buscar Factura..." 
        [(ngModel)]="searchQuery" 
        (ngModelChange)="filterFacturas()"
      />
    </div>

    <table class="table table-bordered">
      <thead class="thead-dark">
        <tr>
          <th># Factura</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Archivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let f of facturasFiltradas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage }">
          <td>{{ f.idFactura }}</td>
          <td>{{ f.fecha | date:'yyyy-MM-dd' }}</td>
          <td [innerHTML]="f.cliente.nombre | highlight:searchQuery"></td>
          <td><span class="badge" [ngClass]="f.estadoPago === 'Cancelado' ? 'bg-success' : 'bg-warning'">{{ f.estadoPago }}</span></td>
          <td><a *ngIf="f.archivo" [href]="'https://localhost:7210/' + f.archivo" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-file-earmark-text-fill" viewBox="0 0 16 16">
              <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1z"/>
            </svg></a></td>
          <td class="text-center">
            <div class="d-flex justify-content-center gap-2">
              <button class="btn btn-info btn-sm" (click)="abrirModalEditar(f)"><i class="fas fa-edit"></i></button>
              <button class="btn btn-danger btn-sm" (click)="abrirModalEliminar(f)"><i class="fas fa-trash-alt"></i></button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
<pagination-controls (pageChange)="currentPage = $event" [responsive]="true"></pagination-controls>

  </div>
</div>

<!-- Modal Nueva Factura -->
<div class="modal fade" id="nuevoFacturaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Nueva Factura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="guardarFactura()">
          <div class="mb-3">
            <label>Fecha</label>
            <input type="date" class="form-control" [(ngModel)]="nuevaFactura.fecha" name="fecha" required />
          </div>
          <div class="mb-3">
            <label>Cliente</label>
            <select class="form-control" [(ngModel)]="nuevaFactura.clienteCedula" name="clienteCedula" required>
              <option *ngFor="let cliente of clientes" [value]="cliente.cedula">{{ cliente.nombre }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Estado de Pago</label>
            <select class="form-control" [(ngModel)]="nuevaFactura.estadoPago" name="estadoPago">
              <option value="Pendiente">Pendiente</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Archivo</label>
            <input type="file" class="form-control" (change)="onFileSelected($event, 'nuevo')" />
          </div>
          <div *ngIf="facturaEdit.archivo === null && facturaEdit.archivoUrl">
            <label class="form-label">Archivo actual:</label>
            <a [href]="'https://localhost:7210/' + facturaEdit.archivoUrl" target="_blank">Ver archivo</a>
          </div>
          <button type="submit" class="btn btn-success w-100">Guardar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Factura -->
<div class="modal fade" id="editarFacturaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Editar Factura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="actualizarFactura()">
          <div class="mb-3">
            <label>Fecha</label>
            <input type="date" class="form-control" [(ngModel)]="facturaEdit.fecha" name="fecha" required />
          </div>
          <div class="mb-3">
            <label>Cliente</label>
            <select class="form-control" [(ngModel)]="facturaEdit.clienteCedula" name="clienteCedula" required>
              <option *ngFor="let cliente of clientes" [value]="cliente.cedula">{{ cliente.nombre }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Estado de Pago</label>
            <select class="form-control" [(ngModel)]="facturaEdit.estadoPago" name="estadoPago">
              <option value="Pendiente">Pendiente</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Archivo (opcional)</label>
            <input type="file" class="form-control" (change)="onFileSelected($event, 'editar')" />
          </div>
          <div *ngIf="facturaEdit.archivoUrl && !facturaEdit.archivo">
            <label class="form-label">Archivo actual:</label>
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-file-alt text-secondary"></i>
              <a [href]="'https://localhost:7210/' + facturaEdit.archivoUrl" target="_blank">
                {{ facturaEdit.archivoNombre }}
              </a>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Actualizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Éxito -->
<div class="modal fade" id="facturaGuardadaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-body text-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-check-circle-fill animate-check" viewBox="0 0 16 16">
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </svg>
        <h4>Factura Guardada con Éxito</h4>
        <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmarEliminacionFacturaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>¿Está seguro de eliminar esta factura?</p>
        <div class="d-flex justify-content-center gap-3">
          <button class="btn btn-si" (click)="confirmarEliminarFactura()">Sí</button>
          <button class="btn btn-no" data-bs-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminación Exitosa -->
<div class="modal fade" id="facturaEliminadaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-body text-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-check-circle-fill animate-check" viewBox="0 0 16 16">
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </svg>
        <h4>Factura Eliminada con Éxito</h4>
        <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>